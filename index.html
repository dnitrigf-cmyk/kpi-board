<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>KPI Board</title>
  <link rel="stylesheet" href="styles.css?v=fix-hard-1" />
</head>

<body class="theme-light"><!-- –º–æ–∂–Ω–æ theme-dark -->
  <header>
    <h1>KPI Board</h1>
    <span class="tag">Firebase Shared</span>
    <button id="themeToggle" class="app-menu-btn" title="Switch theme">‚òÄÔ∏è / üåô</button>
  </header>

  <main>
    <aside class="side">
      <div class="group">
        <button>This department</button>
        <button>All departments</button>
      </div>
      <div class="users-summary"></div>
    </aside>

    <section class="grid-wrap">
      <div class="nav-arrows">
        <button class="nav-btn" id="btnBackLevel" title="Back">‚Üê</button>
        <button class="nav-btn" id="btnHome" title="Months">‚åÇ</button>
      </div>

      <div class="head-controls">
        <button class="hc-btn" id="hcPrev">‚Üê</button>
        <div class="hc-spacer"></div>
        <button class="hc-btn" id="hcNext">‚Üí</button>
      </div>

      <table>
        <thead>
          <tr id="theadRow">
            <th style="min-width:240px;">KPI name</th>
            <th style="min-width:150px;">Target</th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>

      <div class="usersbar">
        <div id="users"></div>
      </div>
    </section>
  </main>

  <div id="modal-root"></div>

  <!-- Theme engine -->
  <script>
  (function(){
    const KEY = 'kpi-theme';
    const root = document.body;
    function apply(theme){
      root.classList.remove('theme-light','theme-dark','light','dark');
      root.classList.add(theme === 'light' ? 'theme-light' : 'theme-dark');
      localStorage.setItem(KEY, theme);
    }
    apply(localStorage.getItem(KEY) || (root.classList.contains('theme-dark') ? 'dark' : 'light'));
    window.toggleTheme = function(){
      apply(root.classList.contains('theme-light') ? 'dark' : 'light');
    };
    const attach = () => {
      const btn = document.getElementById('themeToggle');
      if (btn && !btn.__bound){ btn.__bound = true; btn.addEventListener('click', window.toggleTheme); }
    };
    if (document.readyState === 'loading') document.addEventListener('DOMContentLoaded', attach); else attach();
    new MutationObserver(attach).observe(document.documentElement, {childList:true,subtree:true});
  })();
  </script>

  <!-- —Ç–≤–æ–π –æ—Å–Ω–æ–≤–Ω–æ–π JS -->
  <script defer src="app.js?v=fix-hard-1"></script>

  <!-- ==== PATCH: –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω—ã–π –∏–Ω–ª–∞–π–Ω-—Ü–≤–µ—Ç –±–∞—Ä–æ–≤ –∏–∑ CSS-–ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö —Ç–µ–º—ã ==== -->
  <script>
  (function(){
    function cssVar(name){
      return getComputedStyle(document.body).getPropertyValue(name).trim();
    }
    function colorFromPercent(p){
      if (p >= 80) return cssVar('--bar-green');
      if (p >= 60) return cssVar('--bar-yellow');
      return cssVar('--bar-red');
    }
    // –ø–µ—Ä–µ—Ö–≤–∞—Ç—ã–≤–∞–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ —Ñ—É–Ω–∫—Ü–∏–∏ –∏ –¥–æ–ø–∏—Å—ã–≤–∞–µ–º –∏–º –∏–Ω–ª–∞–π–Ω-—Ü–≤–µ—Ç
    const _make = window.makeProgress;
    if (typeof _make === 'function'){
      window.makeProgress = function(v){
        const el = _make(v);
        const pct = el.querySelector('.pct')?.textContent || '';
        const n = parseFloat(pct.replace('%','')) || null;
        const bar = el.querySelector('.bar');
        if (bar && n != null) bar.style.background = colorFromPercent(n);
        return el;
      }
    }
    const _paint = window.paintCellProgress;
    if (typeof _paint === 'function'){
      window.paintCellProgress = function(container, v){
        _paint(container, v);
        const pct = container.querySelector('.pct')?.textContent || '';
        const n = parseFloat(pct.replace('%','')) || null;
        const bar = container.querySelector('.bar');
        if (bar && n != null) bar.style.background = colorFromPercent(n);
      }
    }
  })();
  </script>
</body>
</html>
