<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>KPI Board</title>

  <!-- антикэш -->
  <link rel="stylesheet" href="styles.css?v=fix-3" />
</head>

<body class="theme-light"><!-- можно стартовать и с theme-dark -->
  <header>
    <h1>KPI Board</h1>
    <span class="tag">Firebase Shared</span>
    <button id="themeToggle" class="app-menu-btn" title="Switch theme">☀️ / 🌙</button>
  </header>

  <main>
    <aside class="side">
      <div class="group">
        <button>This department</button>
        <button>All departments</button>
      </div>
      <div class="users-summary"></div>
    </aside>

    <section class="grid-wrap">
      <div class="nav-arrows">
        <button class="nav-btn" id="btnBackLevel" title="Back">←</button>
        <button class="nav-btn" id="btnHome" title="Months">⌂</button>
      </div>

      <div class="head-controls">
        <button class="hc-btn" id="hcPrev">←</button>
        <div class="hc-spacer"></div>
        <button class="hc-btn" id="hcNext">→</button>
      </div>

      <table>
        <thead>
          <tr id="theadRow">
            <th style="min-width:240px;">KPI name</th>
            <th style="min-width:150px;">Target</th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>

      <div class="usersbar">
        <div id="users"></div>
      </div>
    </section>
  </main>

  <div id="modal-root"></div>

  <!-- Theme engine -->
  <script>
  (function(){
    const KEY = 'kpi-theme';
    const root = document.body;

    function apply(theme){
      root.classList.remove('theme-light','theme-dark','light','dark');
      root.classList.add(theme === 'light' ? 'theme-light' : 'theme-dark');
      localStorage.setItem(KEY, theme);
    }

    // init
    apply(localStorage.getItem(KEY) || (root.classList.contains('theme-dark') ? 'dark' : 'light'));

    // toggle
    window.toggleTheme = function(){
      const theme = root.classList.contains('theme-light') ? 'dark' : 'light';
      apply(theme);
      console.log('Theme:', theme); // диагностика
    };

    // bind button (и при динамическом DOM)
    const attach = () => {
      const btn = document.getElementById('themeToggle');
      if (btn && !btn.__bound){
        btn.__bound = true;
        btn.addEventListener('click', window.toggleTheme);
      }
    };
    if (document.readyState === 'loading')
      document.addEventListener('DOMContentLoaded', attach);
    else attach();
    new MutationObserver(attach).observe(document.documentElement, {childList:true,subtree:true});
  })();
  </script>

  <!-- твой основной JS (оставь как есть) -->
  <script defer src="app.js?v=fix-3"></script>
</body>
</html>
